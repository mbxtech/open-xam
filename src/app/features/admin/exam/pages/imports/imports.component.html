<ox-imports-statistics-header [statistics]="statisticsSignal()" />
<ox-imports-controls (clearAll)="clearAllInvalid()" (refresh)="refreshList()" />

@if (isLoading()) {
<div class="flex items-center justify-center py-16">
    <svg class="h-8 w-8 animate-spin text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
</div>
}

@if (!isLoading()) {
    @if (invalidExamsSignal().length === 0) {
    <div class="mt-8 rounded-md border border-dashed border-neutral-border p-10 text-center text-subtext-color">
        <p class="mb-2 text-heading-3 text-default-font" i18n="@@ox.admin.imports.empty.title">No Failed Imports</p>
        <p i18n="@@ox.admin.imports.empty.message">All your imports succeeded! Failed imports will appear here.</p>
    </div>
    } @else {
        @for (cachedExam of invalidExamsSignal(); track cachedExam.id) {
        <div class="py-4">
            <ox-card class="hover:shadow-lg transition-shadow">
                <div class="flex items-start justify-between gap-4 p-6">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-heading-3 text-default-font truncate">{{ cachedExam.exam.name || 'Unnamed Exam' }}</h3>
                            <ox-badge variant="destructive">
                                <span i18n="@@ox.admin.imports.badge.failed">Failed</span>
                            </ox-badge>
                            @if (cachedExam.exam.category?.name) {
                                <ox-badge variant="secondary">
                                    {{ cachedExam.exam.category!.name }}
                                </ox-badge>
                            }
                        </div>
                        <p class="text-body text-subtext-color mb-3 line-clamp-2">
                            {{ cachedExam.exam.description || 'No description' }}
                        </p>
                        <div class="flex flex-wrap gap-4 text-caption text-subtext-color">
                            <div class="flex items-center gap-1">
                                <span class="font-medium text-default-font">{{ cachedExam.exam.questions?.length || 0 }}</span>
                                <span i18n="@@ox.general.exam.questions">Questions</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="font-medium text-default-font">{{ cachedExam.exam.pointsToSucceeded || 0 }}</span>
                                <span i18n="@@ox.general.exam.pointsToSucceed">Points to succeed</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span i18n="@@ox.admin.imports.cachedAt">Cached at: {{ cachedExam.cachedAt | date: 'dd.MM.yyyy HH:mm:ss' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <ox-button variant="default" size="sm" (click)="goToEdit(cachedExam.id)">
                            <fa-icon class="w-4 h-4 mr-2" [icon]="faPencil" />
                            <span i18n="@@ox.admin.imports.editAndRetry">Edit & Retry</span>
                        </ox-button>
                        <ox-button variant="outline" size="sm" i18n-title="@@ox.general.delete" title="Delete" (click)="openDelete(cachedExam)">
                            <fa-icon class="w-4 h-4 text-error-500" [icon]="faTrash" />
                        </ox-button>
                    </div>
                </div>
            </ox-card>
        </div>
        }
    }
}

<ox-dialog [isOpen]="isDeleteDialogOpen()">
    <ox-dialog-header>
        <h1 i18n="@@ox.admin.imports.deleteDialog.title">Delete Cached Import</h1>
    </ox-dialog-header>
    <ox-dialog-content>
        <p i18n="@@ox.admin.imports.deleteDialog.message">Are you sure you want to delete this cached import? This action cannot be undone.</p>
    </ox-dialog-content>
    <ox-dialog-footer>
        <ox-button variant="outline" (click)="closeDelete()">
            <span i18n="@@ox.general.close">Close</span>
        </ox-button>
        <ox-button variant="destructive" (click)="confirmDelete()">
            <span i18n="@@ox.general.delete">Delete</span>
        </ox-button>
    </ox-dialog-footer>
</ox-dialog>
